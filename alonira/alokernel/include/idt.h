// SPDX-License-Identifier: GPL-3.0-or-later
// Copyright (C) 2022 Emily "TTG" Banerjee <prs.ttg+alonira@pm.me>

#ifndef ALO_KERNEL_IDT_H
#define ALO_KERNEL_IDT_H

#include "cpu.h"
#include "gdt.h"

#include <gencommon.h>
#include <alocommon.h>

typedef enum {
    ALO_IDT_ENTRY_EXCEPTION_DIVIDE_BY_ZERO,
    ALO_IDT_ENTRY_EXCEPTION_DEBUG_TRAP,
    ALO_IDT_ENTRY_EXCEPTION_NMI,
    ALO_IDT_ENTRY_EXCEPTION_BREAKPOINT,
    ALO_IDT_ENTRY_EXCEPTION_OVERFLOW,
    ALO_IDT_ENTRY_EXCEPTION_BOUND_RANGE_EXCEEDED,
    ALO_IDT_ENTRY_EXCEPTION_INVALID_OPCODE,
    ALO_IDT_ENTRY_EXCEPTION_DEVICE_NOT_AVILABLE,
    ALO_IDT_ENTRY_EXCEPTION_DOUBLE_FAULT,
    ALO_IDT_ENTRY_EXCEPTION_COPROCESSOR_SEGMENT_OVERRUN,
    ALO_IDT_ENTRY_EXCEPTION_INVALID_TSS,
    ALO_IDT_ENTRY_EXCEPTION_SEGMENT_NOT_PRESENT,
    ALO_IDT_ENTRY_EXCEPTION_STACK_SEGMENT_FAULT,
    ALO_IDT_ENTRY_EXCEPTION_GENERAL_PROTECTION_FAULT,
    ALO_IDT_ENTRY_EXCEPTION_PAGE_FAULT,
    ALO_IDT_ENTRY_EXCEPTION_RESERVED0,
    ALO_IDT_ENTRY_EXCEPTION_X87_FLOATING_POINT,
    ALO_IDT_ENTRY_EXCEPTION_ALIGNMENT_CHECK,
    ALO_IDT_ENTRY_EXCEPTION_MACHINE_CHECK,
    ALO_IDT_ENTRY_EXCEPTION_SIMD_FLOATING_POINT,
    ALO_IDT_ENTRY_EXCEPTION_VIRTUALIZATION,
    ALO_IDT_ENTRY_EXCEPTION_CONTROL_PROTECTION,
    ALO_IDT_ENTRY_EXCEPTION_RESERVED1,
    ALO_IDT_ENTRY_EXCEPTION_RESERVED2,
    ALO_IDT_ENTRY_EXCEPTION_RESERVED3,
    ALO_IDT_ENTRY_EXCEPTION_RESERVED4,
    ALO_IDT_ENTRY_EXCEPTION_RESERVED5,
    ALO_IDT_ENTRY_EXCEPTION_RESERVED6,
    ALO_IDT_ENTRY_EXCEPTION_HYPERVISOR_INJECTION,
    ALO_IDT_ENTRY_EXCEPTION_VMM_COMMUNICATION,
    ALO_IDT_ENTRY_EXCEPTION_SECURITY,
    ALO_IDT_ENTRY_EXCEPTION_RESERVED7,

    ALO_IDT_ENTRY_IRQ0,
    ALO_IDT_ENTRY_IRQ1,
    ALO_IDT_ENTRY_IRQ2,
    ALO_IDT_ENTRY_IRQ3,
    ALO_IDT_ENTRY_IRQ4,
    ALO_IDT_ENTRY_IRQ5,
    ALO_IDT_ENTRY_IRQ6,
    ALO_IDT_ENTRY_IRQ7,
    ALO_IDT_ENTRY_IRQ8,
    ALO_IDT_ENTRY_IRQ9,
    ALO_IDT_ENTRY_IRQ10,
    ALO_IDT_ENTRY_IRQ11,
    ALO_IDT_ENTRY_IRQ12,
    ALO_IDT_ENTRY_IRQ13,
    ALO_IDT_ENTRY_IRQ14,
    ALO_IDT_ENTRY_IRQ15,
    ALO_IDT_ENTRY_IRQ16,
    ALO_IDT_ENTRY_IRQ17,
    ALO_IDT_ENTRY_IRQ18,
    ALO_IDT_ENTRY_IRQ19,
    ALO_IDT_ENTRY_IRQ20,
    ALO_IDT_ENTRY_IRQ21,
    ALO_IDT_ENTRY_IRQ22,
    ALO_IDT_ENTRY_IRQ23,
    ALO_IDT_ENTRY_IRQ24,
    ALO_IDT_ENTRY_IRQ25,
    ALO_IDT_ENTRY_IRQ26,
    ALO_IDT_ENTRY_IRQ27,
    ALO_IDT_ENTRY_IRQ28,
    ALO_IDT_ENTRY_IRQ29,
    ALO_IDT_ENTRY_IRQ30,
    ALO_IDT_ENTRY_IRQ31,
    ALO_IDT_ENTRY_IRQ32,
    ALO_IDT_ENTRY_IRQ33,
    ALO_IDT_ENTRY_IRQ34,
    ALO_IDT_ENTRY_IRQ35,
    ALO_IDT_ENTRY_IRQ36,
    ALO_IDT_ENTRY_IRQ37,
    ALO_IDT_ENTRY_IRQ38,
    ALO_IDT_ENTRY_IRQ39,
    ALO_IDT_ENTRY_IRQ40,
    ALO_IDT_ENTRY_IRQ41,
    ALO_IDT_ENTRY_IRQ42,
    ALO_IDT_ENTRY_IRQ43,
    ALO_IDT_ENTRY_IRQ44,
    ALO_IDT_ENTRY_IRQ45,
    ALO_IDT_ENTRY_IRQ46,
    ALO_IDT_ENTRY_IRQ47,
    ALO_IDT_ENTRY_IRQ48,
    ALO_IDT_ENTRY_IRQ49,
    ALO_IDT_ENTRY_IRQ50,
    ALO_IDT_ENTRY_IRQ51,
    ALO_IDT_ENTRY_IRQ52,
    ALO_IDT_ENTRY_IRQ53,
    ALO_IDT_ENTRY_IRQ54,
    ALO_IDT_ENTRY_IRQ55,
    ALO_IDT_ENTRY_IRQ56,
    ALO_IDT_ENTRY_IRQ57,
    ALO_IDT_ENTRY_IRQ58,
    ALO_IDT_ENTRY_IRQ59,
    ALO_IDT_ENTRY_IRQ60,
    ALO_IDT_ENTRY_IRQ61,
    ALO_IDT_ENTRY_IRQ62,
    ALO_IDT_ENTRY_IRQ63,
    ALO_IDT_ENTRY_IRQ64,
    ALO_IDT_ENTRY_IRQ65,
    ALO_IDT_ENTRY_IRQ66,
    ALO_IDT_ENTRY_IRQ67,
    ALO_IDT_ENTRY_IRQ68,
    ALO_IDT_ENTRY_IRQ69,
    ALO_IDT_ENTRY_IRQ70,
    ALO_IDT_ENTRY_IRQ71,
    ALO_IDT_ENTRY_IRQ72,
    ALO_IDT_ENTRY_IRQ73,
    ALO_IDT_ENTRY_IRQ74,
    ALO_IDT_ENTRY_IRQ75,
    ALO_IDT_ENTRY_IRQ76,
    ALO_IDT_ENTRY_IRQ77,
    ALO_IDT_ENTRY_IRQ78,
    ALO_IDT_ENTRY_IRQ79,
    ALO_IDT_ENTRY_IRQ80,
    ALO_IDT_ENTRY_IRQ81,
    ALO_IDT_ENTRY_IRQ82,
    ALO_IDT_ENTRY_IRQ83,
    ALO_IDT_ENTRY_IRQ84,
    ALO_IDT_ENTRY_IRQ85,
    ALO_IDT_ENTRY_IRQ86,
    ALO_IDT_ENTRY_IRQ87,
    ALO_IDT_ENTRY_IRQ88,
    ALO_IDT_ENTRY_IRQ89,
    ALO_IDT_ENTRY_IRQ90,
    ALO_IDT_ENTRY_IRQ91,
    ALO_IDT_ENTRY_IRQ92,
    ALO_IDT_ENTRY_IRQ93,
    ALO_IDT_ENTRY_IRQ94,
    ALO_IDT_ENTRY_IRQ95,
    ALO_IDT_ENTRY_IRQ96,
    ALO_IDT_ENTRY_IRQ97,
    ALO_IDT_ENTRY_IRQ98,
    ALO_IDT_ENTRY_IRQ99,
    ALO_IDT_ENTRY_IRQ100,
    ALO_IDT_ENTRY_IRQ101,
    ALO_IDT_ENTRY_IRQ102,
    ALO_IDT_ENTRY_IRQ103,
    ALO_IDT_ENTRY_IRQ104,
    ALO_IDT_ENTRY_IRQ105,
    ALO_IDT_ENTRY_IRQ106,
    ALO_IDT_ENTRY_IRQ107,
    ALO_IDT_ENTRY_IRQ108,
    ALO_IDT_ENTRY_IRQ109,
    ALO_IDT_ENTRY_IRQ110,
    ALO_IDT_ENTRY_IRQ111,
    ALO_IDT_ENTRY_IRQ112,
    ALO_IDT_ENTRY_IRQ113,
    ALO_IDT_ENTRY_IRQ114,
    ALO_IDT_ENTRY_IRQ115,
    ALO_IDT_ENTRY_IRQ116,
    ALO_IDT_ENTRY_IRQ117,
    ALO_IDT_ENTRY_IRQ118,
    ALO_IDT_ENTRY_IRQ119,
    ALO_IDT_ENTRY_IRQ120,
    ALO_IDT_ENTRY_IRQ121,
    ALO_IDT_ENTRY_IRQ122,
    ALO_IDT_ENTRY_IRQ123,
    ALO_IDT_ENTRY_IRQ124,
    ALO_IDT_ENTRY_IRQ125,
    ALO_IDT_ENTRY_IRQ126,
    ALO_IDT_ENTRY_IRQ127,
    ALO_IDT_ENTRY_IRQ128,
    ALO_IDT_ENTRY_IRQ129,
    ALO_IDT_ENTRY_IRQ130,
    ALO_IDT_ENTRY_IRQ131,
    ALO_IDT_ENTRY_IRQ132,
    ALO_IDT_ENTRY_IRQ133,
    ALO_IDT_ENTRY_IRQ134,
    ALO_IDT_ENTRY_IRQ135,
    ALO_IDT_ENTRY_IRQ136,
    ALO_IDT_ENTRY_IRQ137,
    ALO_IDT_ENTRY_IRQ138,
    ALO_IDT_ENTRY_IRQ139,
    ALO_IDT_ENTRY_IRQ140,
    ALO_IDT_ENTRY_IRQ141,
    ALO_IDT_ENTRY_IRQ142,
    ALO_IDT_ENTRY_IRQ143,
    ALO_IDT_ENTRY_IRQ144,
    ALO_IDT_ENTRY_IRQ145,
    ALO_IDT_ENTRY_IRQ146,
    ALO_IDT_ENTRY_IRQ147,
    ALO_IDT_ENTRY_IRQ148,
    ALO_IDT_ENTRY_IRQ149,
    ALO_IDT_ENTRY_IRQ150,
    ALO_IDT_ENTRY_IRQ151,
    ALO_IDT_ENTRY_IRQ152,
    ALO_IDT_ENTRY_IRQ153,
    ALO_IDT_ENTRY_IRQ154,
    ALO_IDT_ENTRY_IRQ155,
    ALO_IDT_ENTRY_IRQ156,
    ALO_IDT_ENTRY_IRQ157,
    ALO_IDT_ENTRY_IRQ158,
    ALO_IDT_ENTRY_IRQ159,
    ALO_IDT_ENTRY_IRQ160,
    ALO_IDT_ENTRY_IRQ161,
    ALO_IDT_ENTRY_IRQ162,
    ALO_IDT_ENTRY_IRQ163,
    ALO_IDT_ENTRY_IRQ164,
    ALO_IDT_ENTRY_IRQ165,
    ALO_IDT_ENTRY_IRQ166,
    ALO_IDT_ENTRY_IRQ167,
    ALO_IDT_ENTRY_IRQ168,
    ALO_IDT_ENTRY_IRQ169,
    ALO_IDT_ENTRY_IRQ170,
    ALO_IDT_ENTRY_IRQ171,
    ALO_IDT_ENTRY_IRQ172,
    ALO_IDT_ENTRY_IRQ173,
    ALO_IDT_ENTRY_IRQ174,
    ALO_IDT_ENTRY_IRQ175,
    ALO_IDT_ENTRY_IRQ176,
    ALO_IDT_ENTRY_IRQ177,
    ALO_IDT_ENTRY_IRQ178,
    ALO_IDT_ENTRY_IRQ179,
    ALO_IDT_ENTRY_IRQ180,
    ALO_IDT_ENTRY_IRQ181,
    ALO_IDT_ENTRY_IRQ182,
    ALO_IDT_ENTRY_IRQ183,
    ALO_IDT_ENTRY_IRQ184,
    ALO_IDT_ENTRY_IRQ185,
    ALO_IDT_ENTRY_IRQ186,
    ALO_IDT_ENTRY_IRQ187,
    ALO_IDT_ENTRY_IRQ188,
    ALO_IDT_ENTRY_IRQ189,
    ALO_IDT_ENTRY_IRQ190,
    ALO_IDT_ENTRY_IRQ191,
    ALO_IDT_ENTRY_IRQ192,
    ALO_IDT_ENTRY_IRQ193,
    ALO_IDT_ENTRY_IRQ194,
    ALO_IDT_ENTRY_IRQ195,
    ALO_IDT_ENTRY_IRQ196,
    ALO_IDT_ENTRY_IRQ197,
    ALO_IDT_ENTRY_IRQ198,
    ALO_IDT_ENTRY_IRQ199,
    ALO_IDT_ENTRY_IRQ200,
    ALO_IDT_ENTRY_IRQ201,
    ALO_IDT_ENTRY_IRQ202,
    ALO_IDT_ENTRY_IRQ203,
    ALO_IDT_ENTRY_IRQ204,
    ALO_IDT_ENTRY_IRQ205,
    ALO_IDT_ENTRY_IRQ206,
    ALO_IDT_ENTRY_IRQ207,
    ALO_IDT_ENTRY_IRQ208,
    ALO_IDT_ENTRY_IRQ209,
    ALO_IDT_ENTRY_IRQ210,
    ALO_IDT_ENTRY_IRQ211,
    ALO_IDT_ENTRY_IRQ212,
    ALO_IDT_ENTRY_IRQ213,
    ALO_IDT_ENTRY_IRQ214,
    ALO_IDT_ENTRY_IRQ215,
    ALO_IDT_ENTRY_IRQ216,
    ALO_IDT_ENTRY_IRQ217,
    ALO_IDT_ENTRY_IRQ218,
    ALO_IDT_ENTRY_IRQ219,
    ALO_IDT_ENTRY_IRQ220,
    ALO_IDT_ENTRY_IRQ221,
    ALO_IDT_ENTRY_IRQ222,
    ALO_IDT_ENTRY_IRQ223,

    ALO_IDT_ENTRY_COUNT
} alo_idt_isr_t;

typedef enum {
    ALO_IDT_GATE_TYPE_INTERRUPT = 0xE,
    ALO_IDT_GATE_TYPE_TRAP = 0xF
} alo_idt_gate_type_t;

#define ALO_IDT_MAKE_ENTRY(offset, ist, gate_type, privilige) ((alo_idt_entry_t) {(offset) & 0xFFFF, alo_gdt_selectors[ALO_GDT_INDEX_CODE], (ist), 0, (gate_type), false, (privilige), true, (offset) >> 2, 0})

typedef struct ALO_PACKED {
    uint16_t offset_low;
    
    alo_segment_selector_t segment_selector;
    
    uint8_t ist : 3;
    uint8_t reserved0 : 5;
    
    alo_idt_gate_type_t gate_type : 4;
    bool reserved1 : 1;
    alo_cpu_privilige_t privilige : 2;
    bool present : 1;

    uint64_t offset_high : 48;

    uint32_t reserved2;
} alo_idt_entry_t;

typedef struct ALO_PACKED {
    uint16_t size;
    const alo_idt_entry_t* offset;
} alo_idt_pointer_t;

extern const alo_idt_entry_t alo_idt[ALO_IDT_ENTRY_COUNT];
extern const alo_idt_pointer_t alo_idtr;

extern gen_error_t* alo_idt_install(void);

#endif
